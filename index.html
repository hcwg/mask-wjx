<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <title></title>
    <style>
        .color-indicator {
            width: 20px;
            height: 20px;
        }
    </style>
</head>

<body>
    <div id="page-wrapper">

        <h1>maskWJX</h1>
        <div>
            <p>Select an ID picture file, then select background, and click mask:</p>
            <input type="file" id="fileInput">
            <button type="button" id="maskButton">Mask</button>
            <div class="color-indicator" id="background_indicator"></div>
        </div>
        <canvas id="imageDisplay"></canvas>

    </div>
    <script type="text/javascript">
        window.onload = function() {
            var fileInput = document.getElementById('fileInput');
            var imageDisplay = document.getElementById('imageDisplay');
            var maskButton = document.getElementById('maskButton');
            var background_indicator = document.getElementById('background_indicator');
            var context = imageDisplay.getContext('2d');

            var maskConfig = {
                background: [255, 255, 255, 255]
            }

            fileInput.addEventListener('change', function(e) {
                var file = fileInput.files[0];
                var imageType = /image.*/;

                if (file.type.match(imageType)) {
                    var reader = new FileReader();

                    reader.onload = function(e) {
                        imageDisplay.innerHTML = "";

                        var img = new Image();
                        img.src = reader.result;

                        img.onload = function(e) {
                            imageDisplay.setAttribute('width', img.width)
                            imageDisplay.setAttribute('height', img.height)
                            context.drawImage(img, 0, 0);
                            maskConfig['img'] = img;
                        }

                    }

                    reader.readAsDataURL(file);
                } else {
                    imageDisplay.innerHTML = "File not supported!"
                }
            });
            imageDisplay.addEventListener('click', function(e) {
                var x = e.x;
                var y = e.y;
                maskConfig.background = context.getImageData(x, y, 1, 1).data;
                var r = maskConfig.background[0];
                var g = maskConfig.background[1];
                var b = maskConfig.background[2];
                var style_str = 'background-color: rgb(' + r + ',' + g + ',' + b + ')';
                background_indicator.setAttribute('style', style_str);
            });
            maskButton.addEventListener('click', function(e) {
                var width = maskConfig.img.width;
                var height = maskConfig.img.height;
                var imageData = context.getImageData(0, 0, width, height)
                var data = imageData.data
                var bk = maskConfig.background
                var mask = []
                const max = bk.indexOf(Math.max(...bk.slice(0, 3)))
                const min = bk.indexOf(Math.min(...bk.slice(0, 3)))
                for (var idx = 0; idx < data.length; idx += 4) {
                    var val = (data[idx + max] - data[idx + min]) * 1.0 / (bk[max] - bk[min]);
                    if (val < 0) {
                        val = 0;
                    }
                    if (val > 1) {
                        val = 1;
                    }
                    mask.push(val);
                }
                var retData = new ImageData(imageData.width, imageData.height)
                var targetBackgroundColor = [255, 128, 128];
                var diffRGB = []
                for (var i = 0; i < 3; i++) {
                    diffRGB.push(targetBackgroundColor[i] - bk[i]);
                }

                for (var idx = 0; idx < retData.data.length; idx += 4) {
                    var m = mask[idx / 4];
                    retData.data[idx + 0] = data[idx + 0] + m * diffRGB[0];
                    retData.data[idx + 1] = data[idx + 1] + m * diffRGB[1];
                    retData.data[idx + 2] = data[idx + 2] + m * diffRGB[2];
                    retData.data[idx + 3] = 255
                }
                context.putImageData(retData, 0, 0)

            });

        }
    </script>

</body>

</html>
